{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "urn:rdpms:core:schema:object-query-dsl:v1",
  "title": "ObjectQueryDsl",
  "type": "object",
  "properties": {
    "$schema": {
      "type": "string",
      "description": "Optional: JSON Schema association hint for editors (e.g., VS Code)."
    }
  },
  "unevaluatedProperties": false,
  "allOf": [
    {
      "oneOf": [
        { "$ref": "#/$defs/LogicalQuery" },
        { "$ref": "#/$defs/FieldQuery" }
      ]
    }
  ],
  "$defs": {
    "Query": {
      "type": "object",
      "unevaluatedProperties": false,
      "oneOf": [
        { "$ref": "#/$defs/LogicalQuery" },
        { "$ref": "#/$defs/FieldQuery" }
      ]
    },

    "LogicalQuery": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "$schema": {
          "type": "string",
          "description": "Optional: JSON Schema association hint for editors (e.g., VS Code)."
        },
        "$and": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Query" }
        },
        "$or": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Query" }
        },
        "$not": { "$ref": "#/$defs/Query" }
      },
      "oneOf": [
        { "required": ["$and"] },
        { "required": ["$or"] },
        { "required": ["$not"] }
      ]
    },

    "FieldQuery": {
      "type": "object",
      "description": "Map of field-path -> constraint. Field paths use dot notation (e.g., 'timeseries.topics').",
      "minProperties": 1,
      "additionalProperties": false,
      "properties": {
        "$schema": {
          "type": "string",
          "description": "Optional: JSON Schema association hint for editors (e.g., VS Code)."
        }
      },
      "patternProperties": {
        "^(?!\\$).+$": { "$ref": "#/$defs/FieldConstraint" }
      }
    },

    "FieldConstraint": {
      "description": "Constraint on a field. Shorthand scalar means {$eq: scalar}.",
      "oneOf": [
        { "$ref": "#/$defs/Scalar" },
        { "$ref": "#/$defs/ConstraintObject" }
      ]
    },

    "ConstraintObject": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "$eq": { "$ref": "#/$defs/Scalar" },
        "$ne": { "$ref": "#/$defs/Scalar" },

        "$in": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/Scalar" }
        },

        "$exists": { "type": "boolean" },

        "$gt": { "$ref": "#/$defs/Scalar" },
        "$gte": { "$ref": "#/$defs/Scalar" },
        "$lt": { "$ref": "#/$defs/Scalar" },
        "$lte": { "$ref": "#/$defs/Scalar" },

        "$regex": {
          "type": "string",
          "description": "Regular expression pattern to match against string fields."
        },

        "$size": {
          "type": "integer",
          "minimum": 0,
          "description": "Exact array length."
        },
        "$gteSize": {
          "type": "integer",
          "minimum": 0,
          "description": "Array length must be >= this value."
        },
        "$lteSize": {
          "type": "integer",
          "minimum": 0,
          "description": "Array length must be <= this value."
        },

        "$elemMatch": {
          "$ref": "#/$defs/ElementQuery",
          "description": "Match at least one element in an array against the provided query (element becomes the root for paths)."
        }
      },
      "minProperties": 1,
      "oneOf": [
        { "required": ["$eq"] },
        { "required": ["$ne"] },
        { "required": ["$in"] },
        { "required": ["$exists"] },
        { "required": ["$gt"] },
        { "required": ["$gte"] },
        { "required": ["$lt"] },
        { "required": ["$lte"] },
        { "required": ["$regex"] },
        { "required": ["$size"] },
        { "required": ["$gteSize"] },
        { "required": ["$lteSize"] },
        { "required": ["$elemMatch"] }
      ]
    },

    "ElementQuery": {
      "description": "Query evaluated with the array element as the root (paths are relative to the element).",
      "type": "object",
      "unevaluatedProperties": false,
      "oneOf": [
        { "$ref": "#/$defs/LogicalElementQuery" },
        { "$ref": "#/$defs/FieldElementQuery" }
      ]
    },

    "LogicalElementQuery": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "$and": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/ElementQuery" }
        },
        "$or": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/ElementQuery" }
        },
        "$not": { "$ref": "#/$defs/ElementQuery" }
      },
      "oneOf": [
        { "required": ["$and"] },
        { "required": ["$or"] },
        { "required": ["$not"] }
      ]
    },

    "FieldElementQuery": {
      "type": "object",
      "minProperties": 1,
      "additionalProperties": false,
      "patternProperties": {
        "^(?!\\$).+$": { "$ref": "#/$defs/FieldConstraint" }
      }
    },

    "Scalar": {
      "description": "Allowed scalar value types for comparisons.",
      "oneOf": [
        { "type": "string" },
        { "type": "number" },
        { "type": "integer" },
        { "type": "boolean" },
        { "type": "null" }
      ]
    }
  }
}
